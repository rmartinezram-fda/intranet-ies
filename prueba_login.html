<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Intranet IES F√©lix de Azara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .login-container { max-width: 400px; margin-top: 100px; }
        .dashboard-container { display: none; margin-top: 30px; } /* Oculto al principio */
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    </style>
</head>
<body>

    <div class="container login-container" id="pantallaLogin">
        <div class="card shadow-lg">
            <div class="card-header header-bg text-center p-4">
                <h3><i class="bi bi-mortarboard-fill"></i> Intranet IES</h3>
                <p class="mb-0">Acceso Docente</p>
            </div>
            <div class="card-body p-4">
                <form onsubmit="event.preventDefault(); login();">
                    <div class="mb-3">
                        <label class="form-label">Email Corporativo</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="text" id="email" class="form-control" value="jamal.bahssain.ajbal@iesfelixdeazara.com">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key"></i></span>
                            <input type="password" id="password" class="form-control" value="1234">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">INICIAR SESI√ìN</button>
                </form>
                <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>
    </div>

    <div class="container dashboard-container" id="pantallaDashboard">
        
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded-3 mb-4 p-3">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-grid-3x3-gap"></i> Panel de Control</a>
                <div class="d-flex align-items-center text-white">
                    <span id="nombreUsuario" class="me-3 fw-bold">Usuario</span>
                    <button onclick="logout()" class="btn btn-outline-light btn-sm">Cerrar Sesi√≥n <i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </nav>

        <div class="row">
            <div class="col-md-4">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-primary">‚ö° Acciones R√°pidas</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button onclick="verHorario()" class="btn btn-outline-primary text-start"><i class="bi bi-calendar-week"></i> Ver Mi Horario</button>
                            <button onclick="verMisReservas()" class="btn btn-outline-info text-start"><i class="bi bi-list-check"></i> Ver Mis Reservas</button>
                            
                            <button id="btnDirector" onclick="entrarDirector()" class="btn btn-outline-danger text-start d-none"><i class="bi bi-shield-lock"></i> Zona Direcci√≥n</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">
                        <i class="bi bi-plus-circle"></i> Nueva Reserva
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label>Aula:</label>
                            <select id="reservaAula" class="form-select">
                                <option value="1">Aula 1 - Inform√°tica</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label>Fecha:</label>
                            <input type="date" id="reservaFecha" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Hora:</label>
                            <select id="reservaHora" class="form-select">
                                <option value="1">1¬™ Hora (08:30)</option>
                                <option value="2">2¬™ Hora (09:25)</option>
                                <option value="3">3¬™ Hora (10:20)</option>
                            </select>
                        </div>
                        <button onclick="hacerReserva()" class="btn btn-warning w-100">Confirmar Reserva</button>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div id="alertaGeneral" class="alert alert-info d-none"></div>
                
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold" id="tituloPanel">
                        üì¢ Tabl√≥n de Informaci√≥n
                    </div>
                    <div class="card-body" id="contenidoPanel">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2">Selecciona una opci√≥n del men√∫ izquierdo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tokenGlobal = '';

        // --- 1. LOGIN ---
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const res = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    tokenGlobal = data.token;
                    
                    // Cambiar de pantalla
                    document.getElementById('pantallaLogin').style.display = 'none';
                    document.getElementById('pantallaDashboard').style.display = 'block';
                    
                    // Poner nombre usuario
                    document.getElementById('nombreUsuario').innerHTML = `<i class="bi bi-person-circle"></i> ${data.user.nombre}`;

                    // Si es director, mostrar bot√≥n rojo
                    if (data.user.rol_id === 1) {
                        document.getElementById('btnDirector').classList.remove('d-none');
                    }

                } else {
                    errorDiv.innerText = "‚ùå " + data.error;
                    errorDiv.classList.remove('d-none');
                }
            } catch (e) {
                alert("Error de conexi√≥n con el servidor");
            }
        }

        function logout() {
            location.reload(); // La forma m√°s f√°cil de cerrar sesi√≥n es recargar
        }

        // --- 2. VER HORARIO ---
        async function verHorario() {
            setLoading("Cargando horario...");
            try {
                const res = await fetch('http://localhost:3000/api/mi-horario', {
                    headers: { 'Authorization': 'Bearer ' + tokenGlobal }
                });
                const clases = await res.json();

                if (clases.length === 0) {
                    pintarEnPanel("üìÖ Tu Horario", "<div class='alert alert-warning'>No tienes clases asignadas.</div>");
                    return;
                }

                let html = `<table class="table table-striped table-hover">
                    <thead class="table-dark"><tr><th>D√≠a</th><th>Hora</th><th>Asignatura</th></tr></thead><tbody>`;
                
                const dias = ["D", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S"];
                clases.forEach(c => {
                    html += `<tr><td>${dias[c.diaSemana]}</td><td>${c.horaClase}¬™</td><td><strong>${c.asignatura}</strong></td></tr>`;
                });
                html += "</tbody></table>";
                
                pintarEnPanel("üìÖ Tu Horario Fijo", html);
            } catch (e) { mostrarAlerta("Error al cargar horario", "danger"); }
        }

        // --- 3. RESERVAR ---
        async function hacerReserva() {
            const aula = document.getElementById('reservaAula').value;
            const fecha = document.getElementById('reservaFecha').value;
            const hora = document.getElementById('reservaHora').value;

            if(!fecha) { mostrarAlerta("‚ö†Ô∏è Selecciona una fecha v√°lida", "warning"); return; }

            try {
                const res = await fetch('http://localhost:3000/api/reservas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tokenGlobal },
                    body: JSON.stringify({ aulaId: aula, fecha: fecha, horaInicio: hora })
                });
                const data = await res.json();

                if(res.ok) {
                    mostrarAlerta(`‚úÖ ¬°Reserva confirmada! (ID: ${data.reserva.id})`, "success");
                    verMisReservas(); // Actualizamos la lista autom√°ticamente
                } else {
                    mostrarAlerta(`‚ùå ${data.error}`, "danger");
                }
            } catch(e) { mostrarAlerta("Error al conectar", "danger"); }
        }

        // --- 4. VER RESERVAS Y BORRAR ---
        async function verMisReservas() {
            setLoading("Buscando reservas...");
            try {
                const res = await fetch('http://localhost:3000/api/mis-reservas', {
                    headers: { 'Authorization': 'Bearer ' + tokenGlobal }
                });
                const reservas = await res.json();

                if (reservas.length === 0) {
                    pintarEnPanel("üìã Mis Reservas", "<p class='text-muted'>No tienes reservas activas.</p>");
                    return;
                }

                let html = `<table class="table align-middle">
                    <thead class="table-primary"><tr><th>Fecha</th><th>Hora</th><th>Aula</th><th>Acci√≥n</th></tr></thead><tbody>`;
                
                reservas.forEach(r => {
                    const fecha = r.fecha.split('T')[0];
                    html += `<tr>
                        <td>${fecha}</td>
                        <td>${r.horaInicio}¬™ Hora</td>
                        <td>${r.aula ? r.aula.nombre : 'Aula '+r.aulaId}</td>
                        <td><button onclick="borrarReserva(${r.id})" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i> Eliminar</button></td>
                    </tr>`;
                });
                html += "</tbody></table>";
                pintarEnPanel("üìã Gesti√≥n de Reservas", html);

            } catch (e) { mostrarAlerta("Error al ver reservas", "danger"); }
        }

        async function borrarReserva(id) {
            if(!confirm("¬øLiberar el aula?")) return;
            try {
                const res = await fetch(`http://localhost:3000/api/reservas/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + tokenGlobal }
                });
                if(res.ok) {
                    mostrarAlerta("Reserva eliminada", "success");
                    verMisReservas();
                }
            } catch(e) { alert("Error"); }
        }

        // --- 5. ZONA DIRECTOR ---
        async function entrarDirector() {
            setLoading("Verificando credenciales de Director...");
            try {
                const res = await fetch('http://localhost:3000/api/admin/panel', {
                    headers: { 'Authorization': 'Bearer ' + tokenGlobal }
                });
                const data = await res.json();
                
                if(res.ok) {
                    pintarEnPanel("üëî Panel de Direcci√≥n", 
                        `<div class="alert alert-success"><h4>${data.mensaje}</h4><p>${data.datos_sensibles}</p></div>`
                    );
                } else {
                    mostrarAlerta(data.error, "danger");
                }
            } catch(e) { mostrarAlerta("Error de acceso", "danger"); }
        }

        // --- UTILIDADES ---
        function pintarEnPanel(titulo, contenido) {
            document.getElementById('tituloPanel').innerText = titulo;
            document.getElementById('contenidoPanel').innerHTML = contenido;
            document.getElementById('alertaGeneral').classList.add('d-none'); // Ocultar alertas viejas
        }

        function setLoading(msg) {
            pintarEnPanel("Cargando...", `<div class="d-flex justify-content-center p-4">
                <div class="spinner-border text-primary" role="status"></div>
                <span class="ms-3 pt-1">${msg}</span></div>`);
        }

        function mostrarAlerta(msg, tipo) {
            const alerta = document.getElementById('alertaGeneral');
            alerta.className = `alert alert-${tipo}`;
            alerta.innerText = msg;
            alerta.classList.remove('d-none');
        }
    </script>
</body>
</html>